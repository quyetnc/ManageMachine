<div class="mobile-app-container" *ngIf="machine">
    <!-- Header -->
    <div class="app-header">
        <button mat-icon-button class="back-btn" (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <span class="header-title">Machine Details</span>
        <div class="header-actions">
            <!-- Placeholder -->
        </div>
    </div>

    <!-- Scrollable Content -->
    <div class="content-scroll-area">
        <div class="detail-header-card">
            <div class="image-section">
                <!-- Show Image if available -->
                <img *ngIf="machine.imageUrl"
                    [src]="machine.imageUrl.startsWith('http') ? machine.imageUrl : 'http://localhost:5037/' + machine.imageUrl"
                    class="machine-detail-img">
                <!-- Fallback Icon -->
                <mat-icon *ngIf="!machine.imageUrl">precision_manufacturing</mat-icon>
            </div>
            <div class="title-section">
                <h2>{{ machine.name }}</h2>
                <span class="type-badge">{{ machine.machineType?.name }}</span>
            </div>
            <div class="status-section">
                <span class="status-chip active">Active</span>
            </div>
        </div>

        <div class="info-card">
            <h3>Description</h3>
            <p>{{ machine.description || 'No description available for this machine.' }}</p>
        </div>

        <div class="info-card">
            <h3>Technical Specs</h3>

            <div class="spec-row" *ngFor="let param of machine.parameters">
                <span class="label">{{ param.parameterName }} ({{ param.parameterUnit }}):</span>
                <span class="value">{{ param.value }}</span>
            </div>

            <div class="empty-specs" *ngIf="!machine.parameters || machine.parameters.length === 0">
                <p>No technical parameters configured.</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions-section" *ngIf="machine && currentUserId">
            <ng-container
                *ngIf="(machine.userId === currentUserId && !machine.tenantId) || (machine.tenantId === currentUserId)">
                <button mat-flat-button color="primary" class="action-btn" *ngIf="!machine.pendingTransferRequestId"
                    (click)="openTransferDialog()">
                    <mat-icon>send</mat-icon> Transfer Machine
                </button>
                <div *ngIf="machine.pendingTransferRequestId" class="pending-section">
                    <span class="status-msg warning">
                        <mat-icon>pending</mat-icon> Transfer Request Pending
                    </span>
                    <button mat-stroked-button color="warn" (click)="cancelRequest()">
                        Cancel Request
                    </button>
                </div>
            </ng-container>

            <button mat-flat-button color="warn" class="action-btn" *ngIf="machine.tenantId === currentUserId"
                (click)="returnMachine()">
                <mat-icon>keyboard_return</mat-icon> Return Machine
            </button>

            <div *ngIf="machine.userId === currentUserId && machine.tenantId" class="status-msg info">
                <mat-icon>info</mat-icon>
                <span>Lent to: <strong>{{ machine.tenantName }}</strong> ({{ machine.status }})</span>
            </div>

            <div *ngIf="machine.tenantId === currentUserId" class="status-msg info">
                <mat-icon>info</mat-icon>
                <span>Borrowed from: <strong>{{ machine.userFullName }}</strong> ({{ machine.status }})</span>
            </div>
        </div>

        <div class="bottom-spacer"></div>
    </div>
</div>

<div *ngIf="!machine" class="loading-state">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading details...</p>
</div>